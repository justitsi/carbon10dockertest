{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.keyFieldsMissingExternal = void 0;\n\nconst graphql_1 = require(\"graphql\");\n\nconst apollo_graphql_1 = require(\"apollo-graphql\");\n\nconst directives_1 = require(\"../../../directives\");\n\nconst utils_1 = require(\"../../utils\");\n\nexports.keyFieldsMissingExternal = ({\n  name: serviceName,\n  typeDefs\n}) => {\n  const errors = [];\n  let keyDirectiveInfoOnTypeExtensions = [];\n  graphql_1.visit(typeDefs, {\n    ObjectTypeExtension(node) {\n      const keyDirectivesOnTypeExtension = utils_1.findDirectivesOnTypeOrField(node, 'key');\n      const keyDirectivesInfo = keyDirectivesOnTypeExtension.map(keyDirective => keyDirective.arguments && utils_1.isStringValueNode(keyDirective.arguments[0].value) ? {\n        typeName: node.name.value,\n        keyArgument: keyDirective.arguments[0].value.value\n      } : null).filter(utils_1.isNotNullOrUndefined);\n      keyDirectiveInfoOnTypeExtensions.push(...keyDirectivesInfo);\n    }\n\n  });\n  let schema = new graphql_1.GraphQLSchema({\n    query: undefined,\n    directives: [...graphql_1.specifiedDirectives, ...directives_1.federationDirectives]\n  });\n\n  try {\n    schema = apollo_graphql_1.buildSchemaFromSDL(typeDefs, schema);\n  } catch (e) {\n    errors.push(e);\n    return errors;\n  }\n\n  const typeInfo = new graphql_1.TypeInfo(schema);\n\n  for (const {\n    typeName,\n    keyArgument\n  } of keyDirectiveInfoOnTypeExtensions) {\n    const keyDirectiveSelectionSet = graphql_1.parse(`fragment __generated on ${typeName} { ${keyArgument} }`);\n    graphql_1.visit(keyDirectiveSelectionSet, graphql_1.visitWithTypeInfo(typeInfo, {\n      Field() {\n        const fieldDef = typeInfo.getFieldDef();\n        const parentType = typeInfo.getParentType();\n\n        if (parentType) {\n          if (!fieldDef) {\n            errors.push(utils_1.errorWithCode('KEY_FIELDS_MISSING_EXTERNAL', utils_1.logServiceAndType(serviceName, parentType.name) + `A @key directive specifies a field which is not found in this service. Add a field to this type with @external.`));\n            return;\n          }\n\n          const externalDirectivesOnField = utils_1.findDirectivesOnTypeOrField(fieldDef.astNode, 'external');\n\n          if (externalDirectivesOnField.length === 0) {\n            errors.push(utils_1.errorWithCode('KEY_FIELDS_MISSING_EXTERNAL', utils_1.logServiceAndType(serviceName, parentType.name) + `A @key directive specifies the \\`${fieldDef.name}\\` field which has no matching @external field.`));\n          }\n        }\n      }\n\n    }));\n  }\n\n  return errors;\n};","map":{"version":3,"sources":["../../../../src/composition/validate/preComposition/keyFieldsMissingExternal.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.keyFieldsMissingExternal = void 0;\nconst graphql_1 = require(\"graphql\");\nconst apollo_graphql_1 = require(\"apollo-graphql\");\nconst directives_1 = require(\"../../../directives\");\nconst utils_1 = require(\"../../utils\");\nexports.keyFieldsMissingExternal = ({ name: serviceName, typeDefs, }) => {\n    const errors = [];\n    let keyDirectiveInfoOnTypeExtensions = [];\n    graphql_1.visit(typeDefs, {\n        ObjectTypeExtension(node) {\n            const keyDirectivesOnTypeExtension = utils_1.findDirectivesOnTypeOrField(node, 'key');\n            const keyDirectivesInfo = keyDirectivesOnTypeExtension\n                .map(keyDirective => keyDirective.arguments &&\n                utils_1.isStringValueNode(keyDirective.arguments[0].value)\n                ? {\n                    typeName: node.name.value,\n                    keyArgument: keyDirective.arguments[0].value.value,\n                }\n                : null)\n                .filter(utils_1.isNotNullOrUndefined);\n            keyDirectiveInfoOnTypeExtensions.push(...keyDirectivesInfo);\n        },\n    });\n    let schema = new graphql_1.GraphQLSchema({\n        query: undefined,\n        directives: [...graphql_1.specifiedDirectives, ...directives_1.federationDirectives],\n    });\n    try {\n        schema = apollo_graphql_1.buildSchemaFromSDL(typeDefs, schema);\n    }\n    catch (e) {\n        errors.push(e);\n        return errors;\n    }\n    const typeInfo = new graphql_1.TypeInfo(schema);\n    for (const { typeName, keyArgument } of keyDirectiveInfoOnTypeExtensions) {\n        const keyDirectiveSelectionSet = graphql_1.parse(`fragment __generated on ${typeName} { ${keyArgument} }`);\n        graphql_1.visit(keyDirectiveSelectionSet, graphql_1.visitWithTypeInfo(typeInfo, {\n            Field() {\n                const fieldDef = typeInfo.getFieldDef();\n                const parentType = typeInfo.getParentType();\n                if (parentType) {\n                    if (!fieldDef) {\n                        errors.push(utils_1.errorWithCode('KEY_FIELDS_MISSING_EXTERNAL', utils_1.logServiceAndType(serviceName, parentType.name) +\n                            `A @key directive specifies a field which is not found in this service. Add a field to this type with @external.`));\n                        return;\n                    }\n                    const externalDirectivesOnField = utils_1.findDirectivesOnTypeOrField(fieldDef.astNode, 'external');\n                    if (externalDirectivesOnField.length === 0) {\n                        errors.push(utils_1.errorWithCode('KEY_FIELDS_MISSING_EXTERNAL', utils_1.logServiceAndType(serviceName, parentType.name) +\n                            `A @key directive specifies the \\`${fieldDef.name}\\` field which has no matching @external field.`));\n                    }\n                }\n            },\n        }));\n    }\n    return errors;\n};\n//# sourceMappingURL=keyFieldsMissingExternal.js.map"]},"metadata":{},"sourceType":"script"}