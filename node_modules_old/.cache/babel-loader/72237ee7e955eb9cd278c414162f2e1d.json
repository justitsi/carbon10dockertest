{"ast":null,"code":"\"use strict\";\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst cosmiconfig_1 = __importDefault(require(\"cosmiconfig\"));\n\nconst cosmiconfig_typescript_loader_1 = __importDefault(require(\"@endemolshinegroup/cosmiconfig-typescript-loader\"));\n\nconst path_1 = require(\"path\");\n\nconst fs_1 = require(\"fs\");\n\nconst lodash_merge_1 = __importDefault(require(\"lodash.merge\"));\n\nconst config_1 = require(\"./config\");\n\nconst utils_1 = require(\"./utils\");\n\nconst vscode_uri_1 = __importDefault(require(\"vscode-uri\"));\n\nconst utilities_1 = require(\"../utilities\");\n\nconst MODULE_NAME = \"apollo\";\nconst defaultFileNames = [\"package.json\", `${MODULE_NAME}.config.js`, `${MODULE_NAME}.config.ts`];\nconst envFileNames = [\".env\", \".env.local\"];\nconst loaders = {\n  \".json\": cosmiconfig_1.default.loadJson,\n  \".js\": cosmiconfig_1.default.loadJs,\n  \".ts\": {\n    async: cosmiconfig_typescript_loader_1.default\n  }\n};\nexports.legacyKeyEnvVar = \"ENGINE_API_KEY\";\nexports.keyEnvVar = \"APOLLO_KEY\";\n\nasync function loadConfig({\n  configPath,\n  configFileName,\n  requireConfig = false,\n  name,\n  type\n}) {\n  const explorer = cosmiconfig_1.default(MODULE_NAME, {\n    searchPlaces: configFileName ? [configFileName] : defaultFileNames,\n    loaders\n  });\n  let loadedConfig;\n\n  try {\n    loadedConfig = await explorer.search(configPath);\n  } catch (error) {\n    return utilities_1.Debug.error(`A config file failed to load with options: ${JSON.stringify(arguments[0])}.\n    The error was: ${error}`);\n  }\n\n  if (configPath && !loadedConfig) {\n    return utilities_1.Debug.error(`A config file failed to load at '${configPath}'. This is likely because this file is empty or malformed. For more information, please refer to: https://go.apollo.dev/t/config`);\n  }\n\n  if (loadedConfig && loadedConfig.filepath.endsWith(\"package.json\")) {\n    utilities_1.Debug.warning('The \"apollo\" package.json configuration key will no longer be supported in Apollo v3. Please use the apollo.config.js file for Apollo project configuration. For more information, see: https://go.apollo.dev/t/config');\n  }\n\n  if (requireConfig && !loadedConfig) {\n    return utilities_1.Debug.error(`No Apollo config found for project. For more information, please refer to: https://go.apollo.dev/t/config`);\n  }\n\n  let engineConfig = {},\n      apiKey,\n      nameFromKey;\n  envFileNames.forEach(envFile => {\n    const dotEnvPath = configPath ? path_1.resolve(configPath, envFile) : path_1.resolve(process.cwd(), envFile);\n\n    if (fs_1.existsSync(dotEnvPath) && fs_1.lstatSync(dotEnvPath).isFile()) {\n      const env = require(\"dotenv\").parse(fs_1.readFileSync(dotEnvPath));\n\n      const legacyKey = env[exports.legacyKeyEnvVar];\n      const key = env[exports.keyEnvVar];\n\n      if (legacyKey && key) {\n        utilities_1.Debug.warning(`Both ${exports.legacyKeyEnvVar} and ${exports.keyEnvVar} were found. ${exports.keyEnvVar} will take precedence.`);\n      }\n\n      if (legacyKey) {\n        utilities_1.Debug.warning(`[Deprecation warning] Setting the key via ${exports.legacyKeyEnvVar} is deprecated and will not be supported in future versions. Please use ${exports.keyEnvVar} instead.`);\n      }\n\n      apiKey = key || legacyKey;\n    }\n  });\n\n  if (apiKey) {\n    engineConfig = {\n      engine: {\n        apiKey\n      }\n    };\n    nameFromKey = utils_1.getServiceFromKey(apiKey);\n  }\n\n  let projectType;\n  if (type) projectType = type;else if (loadedConfig && loadedConfig.config.client) projectType = \"client\";else if (loadedConfig && loadedConfig.config.service) projectType = \"service\";else return utilities_1.Debug.error(\"Unable to resolve project type. Please add either a client or service config. For more information, please refer to https://go.apollo.dev/t/config\");\n  let serviceName = name || nameFromKey;\n\n  if (projectType === \"client\" && loadedConfig && loadedConfig.config.client && typeof loadedConfig.config.client.service === \"string\") {\n    serviceName = loadedConfig.config.client.service;\n  }\n\n  if (!loadedConfig || serviceName || !(loadedConfig.config.client || loadedConfig.config.service)) {\n    loadedConfig = {\n      filepath: configPath || process.cwd(),\n      config: Object.assign(Object.assign({}, loadedConfig && loadedConfig.config), projectType === \"client\" ? {\n        client: Object.assign(Object.assign(Object.assign({}, config_1.DefaultConfigBase), loadedConfig && loadedConfig.config.client), {\n          service: serviceName\n        })\n      } : {\n        service: Object.assign(Object.assign(Object.assign({}, config_1.DefaultConfigBase), loadedConfig && loadedConfig.config.service), {\n          name: serviceName\n        })\n      })\n    };\n  }\n\n  let {\n    config,\n    filepath\n  } = loadedConfig;\n  if (config.client) config = lodash_merge_1.default({\n    client: config_1.DefaultClientConfig\n  }, config);\n  if (config.service) config = lodash_merge_1.default({\n    service: config_1.DefaultServiceConfig\n  }, config);\n  if (engineConfig) config = lodash_merge_1.default(engineConfig, config);\n  config = lodash_merge_1.default({\n    engine: config_1.DefaultEngineConfig\n  }, config);\n  return new config_1.ApolloConfig(config, vscode_uri_1.default.file(path_1.resolve(filepath)));\n}\n\nexports.loadConfig = loadConfig;","map":{"version":3,"sources":["../../src/config/loadConfig.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst cosmiconfig_1 = __importDefault(require(\"cosmiconfig\"));\nconst cosmiconfig_typescript_loader_1 = __importDefault(require(\"@endemolshinegroup/cosmiconfig-typescript-loader\"));\nconst path_1 = require(\"path\");\nconst fs_1 = require(\"fs\");\nconst lodash_merge_1 = __importDefault(require(\"lodash.merge\"));\nconst config_1 = require(\"./config\");\nconst utils_1 = require(\"./utils\");\nconst vscode_uri_1 = __importDefault(require(\"vscode-uri\"));\nconst utilities_1 = require(\"../utilities\");\nconst MODULE_NAME = \"apollo\";\nconst defaultFileNames = [\n    \"package.json\",\n    `${MODULE_NAME}.config.js`,\n    `${MODULE_NAME}.config.ts`\n];\nconst envFileNames = [\".env\", \".env.local\"];\nconst loaders = {\n    \".json\": cosmiconfig_1.default.loadJson,\n    \".js\": cosmiconfig_1.default.loadJs,\n    \".ts\": {\n        async: cosmiconfig_typescript_loader_1.default\n    }\n};\nexports.legacyKeyEnvVar = \"ENGINE_API_KEY\";\nexports.keyEnvVar = \"APOLLO_KEY\";\nasync function loadConfig({ configPath, configFileName, requireConfig = false, name, type }) {\n    const explorer = cosmiconfig_1.default(MODULE_NAME, {\n        searchPlaces: configFileName ? [configFileName] : defaultFileNames,\n        loaders\n    });\n    let loadedConfig;\n    try {\n        loadedConfig = (await explorer.search(configPath));\n    }\n    catch (error) {\n        return utilities_1.Debug.error(`A config file failed to load with options: ${JSON.stringify(arguments[0])}.\n    The error was: ${error}`);\n    }\n    if (configPath && !loadedConfig) {\n        return utilities_1.Debug.error(`A config file failed to load at '${configPath}'. This is likely because this file is empty or malformed. For more information, please refer to: https://go.apollo.dev/t/config`);\n    }\n    if (loadedConfig && loadedConfig.filepath.endsWith(\"package.json\")) {\n        utilities_1.Debug.warning('The \"apollo\" package.json configuration key will no longer be supported in Apollo v3. Please use the apollo.config.js file for Apollo project configuration. For more information, see: https://go.apollo.dev/t/config');\n    }\n    if (requireConfig && !loadedConfig) {\n        return utilities_1.Debug.error(`No Apollo config found for project. For more information, please refer to: https://go.apollo.dev/t/config`);\n    }\n    let engineConfig = {}, apiKey, nameFromKey;\n    envFileNames.forEach(envFile => {\n        const dotEnvPath = configPath\n            ? path_1.resolve(configPath, envFile)\n            : path_1.resolve(process.cwd(), envFile);\n        if (fs_1.existsSync(dotEnvPath) && fs_1.lstatSync(dotEnvPath).isFile()) {\n            const env = require(\"dotenv\").parse(fs_1.readFileSync(dotEnvPath));\n            const legacyKey = env[exports.legacyKeyEnvVar];\n            const key = env[exports.keyEnvVar];\n            if (legacyKey && key) {\n                utilities_1.Debug.warning(`Both ${exports.legacyKeyEnvVar} and ${exports.keyEnvVar} were found. ${exports.keyEnvVar} will take precedence.`);\n            }\n            if (legacyKey) {\n                utilities_1.Debug.warning(`[Deprecation warning] Setting the key via ${exports.legacyKeyEnvVar} is deprecated and will not be supported in future versions. Please use ${exports.keyEnvVar} instead.`);\n            }\n            apiKey = key || legacyKey;\n        }\n    });\n    if (apiKey) {\n        engineConfig = { engine: { apiKey } };\n        nameFromKey = utils_1.getServiceFromKey(apiKey);\n    }\n    let projectType;\n    if (type)\n        projectType = type;\n    else if (loadedConfig && loadedConfig.config.client)\n        projectType = \"client\";\n    else if (loadedConfig && loadedConfig.config.service)\n        projectType = \"service\";\n    else\n        return utilities_1.Debug.error(\"Unable to resolve project type. Please add either a client or service config. For more information, please refer to https://go.apollo.dev/t/config\");\n    let serviceName = name || nameFromKey;\n    if (projectType === \"client\" &&\n        loadedConfig &&\n        loadedConfig.config.client &&\n        typeof loadedConfig.config.client.service === \"string\") {\n        serviceName = loadedConfig.config.client.service;\n    }\n    if (!loadedConfig ||\n        serviceName ||\n        !(loadedConfig.config.client || loadedConfig.config.service)) {\n        loadedConfig = {\n            filepath: configPath || process.cwd(),\n            config: Object.assign(Object.assign({}, (loadedConfig && loadedConfig.config)), (projectType === \"client\"\n                ? {\n                    client: Object.assign(Object.assign(Object.assign({}, config_1.DefaultConfigBase), (loadedConfig && loadedConfig.config.client)), { service: serviceName })\n                }\n                : {\n                    service: Object.assign(Object.assign(Object.assign({}, config_1.DefaultConfigBase), (loadedConfig && loadedConfig.config.service)), { name: serviceName })\n                }))\n        };\n    }\n    let { config, filepath } = loadedConfig;\n    if (config.client)\n        config = lodash_merge_1.default({ client: config_1.DefaultClientConfig }, config);\n    if (config.service)\n        config = lodash_merge_1.default({ service: config_1.DefaultServiceConfig }, config);\n    if (engineConfig)\n        config = lodash_merge_1.default(engineConfig, config);\n    config = lodash_merge_1.default({ engine: config_1.DefaultEngineConfig }, config);\n    return new config_1.ApolloConfig(config, vscode_uri_1.default.file(path_1.resolve(filepath)));\n}\nexports.loadConfig = loadConfig;\n//# sourceMappingURL=loadConfig.js.map"]},"metadata":{},"sourceType":"script"}