{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.providesNotOnEntity = void 0;\n\nconst graphql_1 = require(\"graphql\");\n\nconst utils_1 = require(\"../../utils\");\n\nexports.providesNotOnEntity = ({\n  schema\n}) => {\n  var _a;\n\n  const errors = [];\n  const types = schema.getTypeMap();\n\n  for (const [typeName, namedType] of Object.entries(types)) {\n    if (!graphql_1.isObjectType(namedType)) continue;\n\n    for (const [fieldName, field] of Object.entries(namedType.getFields())) {\n      const fieldFederationMetadata = utils_1.getFederationMetadata(field);\n      const serviceName = fieldFederationMetadata === null || fieldFederationMetadata === void 0 ? void 0 : fieldFederationMetadata.serviceName;\n      if (!serviceName && (fieldFederationMetadata === null || fieldFederationMetadata === void 0 ? void 0 : fieldFederationMetadata.provides) && !(fieldFederationMetadata === null || fieldFederationMetadata === void 0 ? void 0 : fieldFederationMetadata.belongsToValueType)) throw Error('Internal Consistency Error: field with provides information does not have service name.');\n      if (!serviceName) continue;\n\n      const getBaseType = type => graphql_1.isListType(type) || graphql_1.isNonNullType(type) ? getBaseType(type.ofType) : type;\n\n      const baseType = getBaseType(field.type);\n\n      if (fieldFederationMetadata === null || fieldFederationMetadata === void 0 ? void 0 : fieldFederationMetadata.provides) {\n        if (!graphql_1.isObjectType(baseType)) {\n          errors.push(utils_1.errorWithCode('PROVIDES_NOT_ON_ENTITY', utils_1.logServiceAndType(serviceName, typeName, fieldName) + `uses the @provides directive but \\`${typeName}.${fieldName}\\` returns \\`${field.type}\\`, which is not an Object or List type. @provides can only be used on Object types with at least one @key, or Lists of such Objects.`));\n          continue;\n        }\n\n        const fieldType = types[baseType.name];\n        const selectedFieldIsEntity = (_a = utils_1.getFederationMetadata(fieldType)) === null || _a === void 0 ? void 0 : _a.keys;\n\n        if (!selectedFieldIsEntity) {\n          errors.push(utils_1.errorWithCode('PROVIDES_NOT_ON_ENTITY', utils_1.logServiceAndType(serviceName, typeName, fieldName) + `uses the @provides directive but \\`${typeName}.${fieldName}\\` does not return a type that has a @key. Try adding a @key to the \\`${baseType}\\` type.`));\n        }\n      }\n    }\n  }\n\n  return errors;\n};","map":{"version":3,"sources":["../../../../src/composition/validate/postComposition/providesNotOnEntity.ts"],"names":[],"mappings":";;;;;;;AAAA,MAAA,SAAA,GAAA,OAAA,CAAA,SAAA,CAAA;;AAMA,MAAA,OAAA,GAAA,OAAA,CAAA,aAAA,CAAA;;AAMa,OAAA,CAAA,mBAAA,GAAgD,CAAC;AAAE,EAAA;AAAF,CAAD,KAAe;;;AAC1E,QAAM,MAAM,GAAmB,EAA/B;AAEA,QAAM,KAAK,GAAG,MAAM,CAAC,UAAP,EAAd;;AACA,OAAK,MAAM,CAAC,QAAD,EAAW,SAAX,CAAX,IAAoC,MAAM,CAAC,OAAP,CAAe,KAAf,CAApC,EAA2D;AAEzD,QAAI,CAAC,SAAA,CAAA,YAAA,CAAa,SAAb,CAAL,EAA8B;;AAI9B,SAAK,MAAM,CAAC,SAAD,EAAY,KAAZ,CAAX,IAAiC,MAAM,CAAC,OAAP,CAAe,SAAS,CAAC,SAAV,EAAf,CAAjC,EAAwE;AACtE,YAAM,uBAAuB,GAAG,OAAA,CAAA,qBAAA,CAAsB,KAAtB,CAAhC;AACA,YAAM,WAAW,GAAG,uBAAuB,KAAA,IAAvB,IAAA,uBAAuB,KAAA,KAAA,CAAvB,GAAuB,KAAA,CAAvB,GAAA,uBAAuB,CAAE,WAA7C;AAMA,UACE,CAAC,WAAD,KACA,uBAAuB,KAAA,IAAvB,IAAA,uBAAuB,KAAA,KAAA,CAAvB,GAAuB,KAAA,CAAvB,GAAA,uBAAuB,CAAE,QADzB,KAEA,EAAC,uBAAuB,KAAA,IAAvB,IAAA,uBAAuB,KAAA,KAAA,CAAvB,GAAuB,KAAA,CAAvB,GAAA,uBAAuB,CAAE,kBAA1B,CAHF,EAKE,MAAM,KAAK,CACT,yFADS,CAAX;AAGF,UAAI,CAAC,WAAL,EAAkB;;AAElB,YAAM,WAAW,GAAI,IAAD,IAClB,SAAA,CAAA,UAAA,CAAW,IAAX,KAAoB,SAAA,CAAA,aAAA,CAAc,IAAd,CAApB,GACI,WAAW,CAAC,IAAI,CAAC,MAAN,CADf,GAEI,IAHN;;AAIA,YAAM,QAAQ,GAAG,WAAW,CAAC,KAAK,CAAC,IAAP,CAA5B;;AAGA,UAAI,uBAAuB,KAAA,IAAvB,IAAA,uBAAuB,KAAA,KAAA,CAAvB,GAAuB,KAAA,CAAvB,GAAA,uBAAuB,CAAE,QAA7B,EAAuC;AACrC,YAAI,CAAC,SAAA,CAAA,YAAA,CAAa,QAAb,CAAL,EAA6B;AAC3B,UAAA,MAAM,CAAC,IAAP,CACE,OAAA,CAAA,aAAA,CACE,wBADF,EAEE,OAAA,CAAA,iBAAA,CAAkB,WAAlB,EAA+B,QAA/B,EAAyC,SAAzC,IACE,sCAAsC,QAAQ,IAAI,SAAS,gBAAgB,KAAK,CAAC,IAAI,uIAHzF,CADF;AAOA;AACD;;AAED,cAAM,SAAS,GAAG,KAAK,CAAC,QAAQ,CAAC,IAAV,CAAvB;AACA,cAAM,qBAAqB,GAAA,CAAA,EAAA,GAAG,OAAA,CAAA,qBAAA,CAAsB,SAAtB,CAAH,MAAmC,IAAnC,IAAmC,EAAA,KAAA,KAAA,CAAnC,GAAmC,KAAA,CAAnC,GAAmC,EAAA,CAAE,IAAhE;;AAEA,YAAI,CAAC,qBAAL,EAA4B;AAC1B,UAAA,MAAM,CAAC,IAAP,CACE,OAAA,CAAA,aAAA,CACE,wBADF,EAEE,OAAA,CAAA,iBAAA,CAAkB,WAAlB,EAA+B,QAA/B,EAAyC,SAAzC,IACE,sCAAsC,QAAQ,IAAI,SAAS,yEAAyE,QAAQ,UAHhJ,CADF;AAOD;AACF;AACF;AACF;;AAED,SAAO,MAAP;AACD,CAhEY","sourceRoot":"","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.providesNotOnEntity = void 0;\nconst graphql_1 = require(\"graphql\");\nconst utils_1 = require(\"../../utils\");\nexports.providesNotOnEntity = ({ schema }) => {\n    var _a;\n    const errors = [];\n    const types = schema.getTypeMap();\n    for (const [typeName, namedType] of Object.entries(types)) {\n        if (!graphql_1.isObjectType(namedType))\n            continue;\n        for (const [fieldName, field] of Object.entries(namedType.getFields())) {\n            const fieldFederationMetadata = utils_1.getFederationMetadata(field);\n            const serviceName = fieldFederationMetadata === null || fieldFederationMetadata === void 0 ? void 0 : fieldFederationMetadata.serviceName;\n            if (!serviceName && (fieldFederationMetadata === null || fieldFederationMetadata === void 0 ? void 0 : fieldFederationMetadata.provides) &&\n                !(fieldFederationMetadata === null || fieldFederationMetadata === void 0 ? void 0 : fieldFederationMetadata.belongsToValueType))\n                throw Error('Internal Consistency Error: field with provides information does not have service name.');\n            if (!serviceName)\n                continue;\n            const getBaseType = (type) => graphql_1.isListType(type) || graphql_1.isNonNullType(type)\n                ? getBaseType(type.ofType)\n                : type;\n            const baseType = getBaseType(field.type);\n            if (fieldFederationMetadata === null || fieldFederationMetadata === void 0 ? void 0 : fieldFederationMetadata.provides) {\n                if (!graphql_1.isObjectType(baseType)) {\n                    errors.push(utils_1.errorWithCode('PROVIDES_NOT_ON_ENTITY', utils_1.logServiceAndType(serviceName, typeName, fieldName) +\n                        `uses the @provides directive but \\`${typeName}.${fieldName}\\` returns \\`${field.type}\\`, which is not an Object or List type. @provides can only be used on Object types with at least one @key, or Lists of such Objects.`));\n                    continue;\n                }\n                const fieldType = types[baseType.name];\n                const selectedFieldIsEntity = (_a = utils_1.getFederationMetadata(fieldType)) === null || _a === void 0 ? void 0 : _a.keys;\n                if (!selectedFieldIsEntity) {\n                    errors.push(utils_1.errorWithCode('PROVIDES_NOT_ON_ENTITY', utils_1.logServiceAndType(serviceName, typeName, fieldName) +\n                        `uses the @provides directive but \\`${typeName}.${fieldName}\\` does not return a type that has a @key. Try adding a @key to the \\`${baseType}\\` type.`));\n                }\n            }\n        }\n    }\n    return errors;\n};\n//# sourceMappingURL=providesNotOnEntity.js.map"]},"metadata":{},"sourceType":"script"}